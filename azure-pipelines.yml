# Azure DevOps Pipeline for AgentGateway E2E Tests

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'tests/**'
      - 'azure-config.yaml'
      - 'Dockerfile.acr'

pr:
  branches:
    include:
      - main

schedules:
  - cron: "0 6 * * *"  # Daily at 6 AM UTC
    displayName: Daily E2E Tests
    branches:
      include:
        - main
    always: true

variables:
  - name: gatewayUrl
    value: 'https://unitone-agentgateway.whitecliff-a0c9f0f7.eastus2.azurecontainerapps.io'
  - name: resourceGroup
    value: 'mcp-gateway-dev-rg'
  - name: pythonVersion
    value: '3.11'

stages:
  - stage: E2E_Tests
    displayName: 'End-to-End Tests'
    jobs:
      - job: RunTests
        displayName: 'Run E2E Test Suite'
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 15

        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r tests/requirements-e2e.txt
            displayName: 'Install dependencies'

          - script: |
              python tests/e2e_mcp_pii_test.py
            displayName: 'Run E2E tests'
            env:
              GATEWAY_URL: $(gatewayUrl)

          - script: |
              python tests/test_security_guards.py
            displayName: 'Run security guards tests'
            continueOnError: true

          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              testRunTitle: 'E2E Test Results'
            displayName: 'Publish test results'

  - stage: Health_Checks
    displayName: 'Service Health Checks'
    dependsOn: []  # Run in parallel with E2E tests
    jobs:
      - job: HealthCheck
        displayName: 'Check Service Health'
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 5

        steps:
          - task: AzureCLI@2
            displayName: 'Check AgentGateway health'
            inputs:
              azureSubscription: 'Azure-ServiceConnection'  # Configure this
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Check UI endpoint
                response=$(curl -s -o /dev/null -w "%{http_code}" $(gatewayUrl)/ui)

                if [ "$response" = "401" ] || [ "$response" = "200" ]; then
                  echo "✓ AgentGateway is healthy (HTTP $response)"
                else
                  echo "✗ AgentGateway returned unexpected status: $response"
                  exit 1
                fi

          - task: AzureCLI@2
            displayName: 'Check PII server logs'
            inputs:
              azureSubscription: 'Azure-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az containerapp logs show \
                  --name mcp-pii-test-server \
                  --resource-group $(resourceGroup) \
                  --tail 20
            continueOnError: true
